<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfólio | Matheus Ferraretto</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-50 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <h1 class="font-semibold tracking-tight">Matheus Ferraretto</h1>
      <nav class="flex gap-4 text-sm">
        <a href="#portfolio" class="hover:text-slate-900">Portfólio</a>
        <a href="#videos" class="hover:text-slate-900">Vídeos</a>
        <a href="#contato" class="hover:text-slate-900">Contato</a>
      </nav>
      <a href="#admin" class="px-3 py-2 rounded-xl border border-slate-300 text-sm">Login</a>
    </div>
  </header>

  <section id="portfolio" class="py-16">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6">Portfólio de Imagens</h2>
      <div id="imageAlbums" class="space-y-10"></div>
    </div>
  </section>

  <section id="videos" class="py-16 bg-slate-50">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6">Galeria de Vídeos</h2>
      <div id="videoAlbums" class="space-y-10"></div>
    </div>
  </section>

  <section id="admin" class="py-16 bg-white">
    <div class="max-w-md mx-auto px-4">
      <h2 class="text-2xl font-bold mb-4">Login Administrativo</h2>
      <form id="loginForm" class="grid gap-4">
        <input id="email" type="email" placeholder="E-mail" required class="px-3 py-2 border rounded-lg">
        <input id="password" type="password" placeholder="Senha" required class="px-3 py-2 border rounded-lg">
        <button type="submit" class="bg-slate-900 text-white px-4 py-2 rounded-lg">Entrar</button>
        <p id="loginStatus" class="text-sm text-slate-600"></p>
      </form>

      <form id="uploadForm" class="hidden mt-10 grid gap-4 bg-slate-50 p-6 rounded-2xl border border-slate-200">
        <h3 class="text-lg font-semibold">Adicionar novo item</h3>
        <input id="fldTitle" placeholder="Título" required class="px-3 py-2 border rounded-lg">
        <select id="fldType" class="px-3 py-2 border rounded-lg">
          <option value="image">Imagem</option>
          <option value="video">Vídeo</option>
        </select>
        <select id="fldCat" class="px-3 py-2 border rounded-lg">
          <option value="foto">Fotos</option>
          <option value="infografico">Infográficos</option>
          <option value="ambiente">Ambientado</option>
        </select>
        <div class="grid gap-2">
          <label class="text-sm font-medium" for="fldAlbum">Álbum</label>
          <select id="fldAlbum" class="px-3 py-2 border rounded-lg"></select>
          <input id="fldNewAlbum" placeholder="ou crie um novo álbum" class="px-3 py-2 border rounded-lg">
        </div>
        <input id="fldCaption" placeholder="Legenda" class="px-3 py-2 border rounded-lg">
        <input id="fldFile" type="file" accept="image/*,video/mp4" class="px-3 py-2 border rounded-lg">
        <input id="fldEmbed" type="url" placeholder="https://www.youtube.com/embed/ID" class="px-3 py-2 border rounded-lg">
        <button id="btnUpload" type="submit" class="bg-slate-900 text-white px-4 py-2 rounded-lg">Salvar</button>
        <p id="uploadStatus" class="text-sm text-slate-600"></p>
      </form>
    </div>
  </section>

  <footer class="py-6 text-center text-sm text-slate-500 border-t">© <span id="year"></span> Matheus Ferraretto</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC78l9b2DTNj64y_0fbRKofNupO6NHDmeo",
      authDomain: "matheus-35023.firebaseapp.com",
      projectId: "matheus-35023",
      storageBucket: "matheus-35023.appspot.com",
      messagingSenderId: "1011113149395",
      appId: "1:1011113149395:web:c1f449e0e974ca8ecb2526"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storageBucket = firebaseConfig.storageBucket;
    const storage = storageBucket
      ? getStorage(app, `gs://${storageBucket}`)
      : getStorage(app);

    const loginForm = document.getElementById('loginForm');
    const uploadForm = document.getElementById('uploadForm');
    const loginStatus = document.getElementById('loginStatus');
    const albumSelect = document.getElementById('fldAlbum');
    const newAlbumInput = document.getElementById('fldNewAlbum');
    const uploadStatus = document.getElementById('uploadStatus');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      loginStatus.textContent = 'Entrando...';
      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginStatus.textContent = 'Login realizado com sucesso!';
      } catch (err) {
        loginStatus.textContent = 'Erro: ' + err.message;
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginForm.classList.add('hidden');
        uploadForm.classList.remove('hidden');
      } else {
        loginForm.classList.remove('hidden');
        uploadForm.classList.add('hidden');
      }
    });

    const colRef = collection(db, 'SitePortfolio');
    const albumsRef = collection(db, 'Albums');
    const albumsCache = new Map();

    function populateAlbumSelect() {
      albumSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Selecione um álbum';
      albumSelect.appendChild(placeholder);

      Array.from(albumsCache.entries())
        .sort((a, b) => a[1].localeCompare(b[1]))
        .forEach(([id, name]) => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = name;
          albumSelect.appendChild(option);
        });
    }

    async function loadAlbums() {
      albumsCache.clear();
      const qAlbums = query(albumsRef, orderBy('name'));
      const snap = await getDocs(qAlbums);
      snap.forEach(doc => {
        const data = doc.data();
        albumsCache.set(doc.id, data.name);
      });
      populateAlbumSelect();
    }

    function groupByAlbum(items) {
      const grouped = new Map();
      items.forEach(item => {
        const key = item.albumId || 'sem-album';
        const name = item.albumName || 'Sem álbum';
        if (!grouped.has(key)) {
          grouped.set(key, { name, items: [] });
        }
        grouped.get(key).items.push(item);
      });
      return Array.from(grouped.values());
    }

    function renderImages(items) {
      const container = document.getElementById('imageAlbums');
      container.innerHTML = '';
      const images = items.filter(item => item.type === 'image');
      if (!images.length) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhuma imagem cadastrada ainda.</p>';
        return;
      }

      const groups = groupByAlbum(images);
      groups.forEach(group => {
        const section = document.createElement('section');
        section.className = 'space-y-4';
        section.innerHTML = `<h3 class="text-xl font-semibold">${group.name}</h3>`;

        const grid = document.createElement('div');
        grid.className = 'grid sm:grid-cols-2 lg:grid-cols-3 gap-6';

        group.items.forEach(item => {
          const figure = document.createElement('figure');
          figure.className = 'space-y-2';
          figure.innerHTML = `
            <img src="${item.url}" alt="${item.title}" class="w-full rounded-lg object-cover">
            <figcaption class="text-sm text-slate-600">
              <span class="block font-semibold">${item.title}</span>
              ${item.caption ? `<span class="block">${item.caption}</span>` : ''}
            </figcaption>
          `;
          grid.appendChild(figure);
        });

        section.appendChild(grid);
        container.appendChild(section);
      });
    }

    function renderVideos(items) {
      const container = document.getElementById('videoAlbums');
      container.innerHTML = '';
      const videos = items.filter(item => item.type === 'video');
      if (!videos.length) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhum vídeo cadastrado ainda.</p>';
        return;
      }

      const groups = groupByAlbum(videos);
      groups.forEach(group => {
        const section = document.createElement('section');
        section.className = 'space-y-4';
        section.innerHTML = `<h3 class="text-xl font-semibold">${group.name}</h3>`;

        const grid = document.createElement('div');
        grid.className = 'grid sm:grid-cols-2 lg:grid-cols-3 gap-6';

        group.items.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.className = 'space-y-2';
          wrapper.innerHTML = `
            <iframe src="${item.embedUrl || item.url}" class="w-full rounded-lg aspect-video" allowfullscreen></iframe>
            <div class="text-sm text-slate-600">
              <span class="block font-semibold">${item.title}</span>
              ${item.caption ? `<span class="block">${item.caption}</span>` : ''}
            </div>
          `;
          grid.appendChild(wrapper);
        });

        section.appendChild(grid);
        container.appendChild(section);
      });
    }

    async function loadPortfolio() {
      const qItems = query(colRef, orderBy('createdAt', 'desc'));
      const snap = await getDocs(qItems);
      const items = [];
      snap.forEach(doc => {
        items.push(doc.data());
      });
      renderImages(items);
      renderVideos(items);
    }

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('fldTitle').value;
      const type = document.getElementById('fldType').value;
      const category = document.getElementById('fldCat').value;
      const caption = document.getElementById('fldCaption').value;
      const file = document.getElementById('fldFile').files[0];
      const embedUrl = document.getElementById('fldEmbed').value.trim();
      const selectedAlbum = albumSelect.value;
      const newAlbum = newAlbumInput.value.trim();

      try {
        uploadStatus.textContent = 'Enviando...';

        if (!selectedAlbum && !newAlbum) {
          throw new Error('Selecione um álbum existente ou informe um novo nome.');
        }

        if (type === 'image' && !file) {
          throw new Error('Selecione um arquivo de imagem para salvar.');
        }

        if (type === 'video' && !file && !embedUrl) {
          throw new Error('Envie um arquivo de vídeo ou informe um link incorporado.');
        }

        let albumId = selectedAlbum;
        let albumName = albumsCache.get(selectedAlbum) || '';

        if (newAlbum) {
          const albumDoc = await addDoc(albumsRef, {
            name: newAlbum,
            createdAt: serverTimestamp()
          });
          albumId = albumDoc.id;
          albumName = newAlbum;
          albumsCache.set(albumId, albumName);
          populateAlbumSelect();
          albumSelect.value = albumId;
        }

        const userForUpload = await ensureAuthenticatedUser();
        const ownerUid = userForUpload.uid;

        let url = '';
        if (file) {
          url = await uploadFileWithCorsSupport(type, file, ownerUid);
        }

        const normalizedEmbedUrl = type === 'video' ? embedUrl : '';

        await addDoc(colRef, {
          title,
          type,
          category,
          caption,
          url,
          embedUrl: normalizedEmbedUrl,
          albumId,
          albumName,
          createdAt: serverTimestamp(),
          ownerUid
        });

        uploadStatus.textContent = 'Item salvo com sucesso!';
        uploadForm.reset();
        albumSelect.value = albumId;
        await loadPortfolio();
      } catch (err) {
        uploadStatus.textContent = 'Erro: ' + err.message;
      }
    });

    document.getElementById('year').textContent = new Date().getFullYear();

    loadAlbums().then(loadPortfolio);

    async function ensureAuthenticatedUser() {
      if (auth.currentUser) {
        return auth.currentUser;
      }

      await signInAnonymously(auth);
      if (!auth.currentUser) {
        throw new Error('Não foi possível autenticar para envio.');
      }
      return auth.currentUser;
    }

    async function uploadFileWithCorsSupport(type, file, uid) {
      if (!storageBucket) {
        throw new Error('Bucket do Storage não está configurado.');
      }

      const sanitizedName = file.name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9._-]+/g, '_');
      const timestampedName = `${Date.now()}-${sanitizedName}`;
      const folder = type === 'video' ? 'video' : 'image';
      const fileRef = ref(storage, `portfolio/${uid}/${folder}/${timestampedName}`);

      const metadata = {
        contentType: file.type || (type === 'video' ? 'video/mp4' : 'image/png')
      };

      return await new Promise((resolve, reject) => {
        const task = uploadBytesResumable(fileRef, file, metadata);
        task.on('state_changed',
          (snap) => {
            const progress = (snap.bytesTransferred / snap.totalBytes) * 100;
            uploadStatus.textContent = `Enviando... ${progress.toFixed(0)}%`;
          },
          (err) => {
            reject(err);
          },
          async () => {
            try {
              const downloadURL = await getDownloadURL(task.snapshot.ref);
              resolve(downloadURL);
            } catch (error) {
              reject(error);
            }
          }
        );
      });
    }
  </script>
</body>
</html>
